name: build-dependencies

on:
  push:

jobs:
  vcpkg:
    name: build-${{ matrix.os }}-${{ matrix.package }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: 
          - ubuntu-latest
          # - macos-latest
          # - windows-latest
        package:
          - fmt
          - z3
          - capnproto
          - magic-enum
          - immer
      fail-fast: false
    steps:
      - uses: actions/checkout@v2
        with:
          repository: microsoft/vcpkg
          ref: "2021.05.12"
          path: vcpkg

      - uses: actions/cache@v2
        id: vcpkgcache
        with:
          path: |
            ~/vcpkg/vcpkg
            ~/vcpkg/vcpkg.exe
          key: vcpkg-${{ matrix.os }}-${{ hashFiles('vcpkg/.git/HEAD') }}

      - name: Install vcpkg on unix
        if: ${{ !steps.vcpkgcache.outputs.cache-hit && matrix.os != 'windows-latest' }}
        shell: bash
        run: |
          ./vcpkg/bootstrap-vcpkg.sh -disableMetrics
      
      - name: Install vcpkg on windows
        if: ${{ !steps.vcpkgcache.outputs.cache-hit && matrix.os == 'windows-latest' }}
        shell: bash
        run: |
          ./vcpkg/bootstrap-vcpkg.bat -disableMetrics

      - name: Setup vcpkg triplet
        if: ${{ matrix.os == 'ubuntu-latest' }}
        shell: bash
        run: |
          echo "VCPKG_TRIPLET=x64-linux" >> $GITHUB_ENV
          
      - name: Setup vcpkg triplet
        if: ${{ matrix.os == 'macos-latest' }}
        shell: bash
        run: |
          echo "VCPKG_TRIPLET=x64-osx" >> $GITHUB_ENV
      
      - name: Setup vcpkg triplet
        if: ${{ matrix.os == 'windows-latest' }}
        shell: bash
        run: |
          echo "VCPKG_TRIPLET=x64-windows" >> $GITHUB_ENV 

      - name: Install ${{ matrix.package }}
        shell: bash
        run: |
          ./vcpkg/vcpkg install --triplet=${{ env.VCPKG_TRIPLET }} ${{ matrix.package }}
          ./vcpkg/vcpkg export  --triplet=${{ env.VCPKG_TRIPLET }} ${{ matrix.package }} \
            --output-dir=. \
            --output=${{ matrix.package }} \
            --raw

          tar c ${{ matrix.package }} | xz -4e > ${{ matrix.package }}.tar.xz

      - uses: actions/upload-artifact@v2
        with:
          name: ${{ matrix.package }}-${{ matrix.os }}.tar.xz
          path: ${{ matrix.package }}.tar.xz