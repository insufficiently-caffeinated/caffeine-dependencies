name: build-dependencies

on:
  push:
    inputs:
      manual:
        default: 'false'
  workflow_dispatch:
    inputs:
      manual:
        default: 'true'

env:
  LLVM_COMMIT: 'llvmorg-13.0.0'
  VCPKG_COMMIT: 'ac030b40d53f820bad26148ed6ee46d6fd0f183d'
  LINUX_TAG: 'v5.14'

jobs:
  linux:
    name: build-linux-${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch:
          - i686
          - arm
      fail-fast: false
    steps:
      - uses: actions/checkout@v2
        with:
          repository: torvalds/linux
          ref: ${{ env.LINUX_TAG }}
          path: linux

      - name: Install linux headers
        shell: bash
        run: |
          mkdir -p linux-install
          cd linux-git
          make -j2 ARCH=${{ matrix.arch }} INSTALL_HDR_PATH=../linux-install

      - name: Package linux headers
        shell: bash
        run: |
          tar -c linux | xz -T0 -4e linux-${{ matrix.arch }}.tar.xz
          
      - uses: actions/upload-artifact@v2
        with:
          name: packages
          path: linux-${{ matrix.arch }}.tar.xz

  release:
    name: release
    runs-on: ubuntu-latest
    needs:
      - linux
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v2
        with:
          path: ${{ runner.workspace }}

      - name: List all artifacts
        shell: bash
        run: |
          ls ${{ runner.workspace }}/packages

      - name: Export date
        shell: bash
        run: |
          echo RELEASE_DATE=$(date '+%Y-%m-%d-%H-%M') >> $GITHUB_ENV
          echo ${{ inputs.manual }}

      - uses: softprops/action-gh-release@v1
        # if: ${{ inputs.manual == 'true' }}
        with:
          files: ${{ runner.workspace}}/packages/*.tar.xz
          name: caffeine-deps-${{ env.RELEASE_DATE }}
          tag_name: caffeine-deps-${{ env.RELEASE_DATE }}
          draft: true
